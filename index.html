<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meijin System - Honinbo Road</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --goban: #deb887; --ink: #1a1a1a; --paper: #fdfaf5; --accent: #8b0000; --win: #27ae60; --gold: #d4af37; }
        body { font-family: 'Quicksand', sans-serif; background-color: #f4ece0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .admin-bar { background: var(--ink); color: white; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .admin-bar input { padding: 5px; border-radius: 5px; border: none; width: 100px; margin: 0 5px; }

        /* Honinbo Qualifier Banner */
        .qualifier-banner { background: linear-gradient(45deg, #1a1a1a, #444); color: var(--gold); padding: 20px; border-radius: 15px; border: 3px solid var(--gold); text-align: center; margin-bottom: 25px; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .qualifier-banner h2 { margin: 0; font-family: 'Noto Serif JP', serif; letter-spacing: 2px; }
        .qualifier-names { font-size: 1.5rem; font-weight: bold; color: white; margin-top: 10px; }

        header { background: white; padding: 20px; border-radius: 20px; text-align: center; border-bottom: 8px solid var(--accent); margin-bottom: 30px; }
        .main-grid { display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .rules-card { background: #fffde7; border-left: 5px solid var(--goban); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; }
        .match-box { background: var(--paper); border: 2px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .stone { width: 22px; height: 22px; border-radius: 50%; display: inline-block; vertical-align: middle; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .black { background: #111; } .white { background: #fff; border: 1px solid #ccc; }
        
        .btn-finish { background: var(--win); color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-swap { background: #eee; color: #666; border: 1px solid #ccc; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; margin-top: 5px; }
        .btn-round { background: var(--accent); color: white; width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        
        .admin-only { display: none; }
        .scroll-area { max-height: 400px; overflow-y: auto; }
        .player-row { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .points-badge { background: var(--ink); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-bar">
        <div id="loginStatus">Guest Mode</div>
        <div id="loginFields">
            <input type="text" id="adminUser" placeholder="User">
            <input type="password" id="adminPass" placeholder="Pass">
            <button onclick="checkLogin()">Login</button>
        </div>
        <button id="logoutBtn" style="display:none;" onclick="location.reload()">Logout</button>
    </div>

    <div id="honinboBanner" class="qualifier-banner">
        <h2>HONINBO TOURNAMENT QUALIFIERS</h2>
        <div id="qualifierNames" class="qualifier-names">--- & ---</div>
        <p style="margin: 5px 0 0; font-size: 0.8rem; opacity: 0.8;">Automatically qualified based on current season rankings</p>
    </div>

    <header>
        <h1>MEIJIN SYSTEM</h1>
        <p id="tourneyTitle">Connecting...</p>
        <div id="cycleStatus" style="font-weight: bold; color: var(--accent); margin-top: 10px;">Season Progress: 0/4 Tournaments</div>
    </header>

    <div class="main-grid">
        <aside>
            <div class="rules-card">
                <div class="rules-title">üìú System Rules</div>
                ‚Ä¢ Win: <b>+10 pts</b> | Loss: <b>-5 pts</b><br>
                ‚Ä¢ <b>Top 2</b> qualify for Honinbo<br>
                ‚Ä¢ Reset every <b>4 tournaments</b>
            </div>

            <div class="card">
                <h3>Rankings</h3>
                <div class="admin-only">
                    <input type="text" id="dbName" placeholder="Name">
                    <input type="text" id="dbRank" placeholder="Rank">
                    <button onclick="dbAddPlayer()" style="width:100%; background:var(--ink); color:white; border:none; padding:8px; margin-top:5px; cursor:pointer;">Add Player</button>
                </div>
                <div id="dbList" class="scroll-area"></div>
            </div>
        </aside>

        <main>
            <div id="tourneySetup" class="card">
                <h3>New Tournament</h3>
                <input type="text" id="newTourneyName" placeholder="Tournament Name" class="admin-only">
                <button class="btn-round admin-only" onclick="tourneyStart()">Start Event</button>
            </div>

            <div id="tourneyActive" class="card" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="activeName">Live Matches</h3>
                    <button class="admin-only btn-finish" onclick="tourneyArchive()">Finish & Archive</button>
                </div>
                <div id="roundActions"></div>
                <div id="matchZone"></div>
            </div>

            <div class="card">
                <h3>Tournament History</h3>
                <div id="archiveList" class="scroll-area"></div>
            </div>
        </main>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDzse9aVDIAFscTbGs-3Disy2wdRHWPRF0",
        authDomain: "meijin-system.firebaseapp.com",
        projectId: "meijin-system",
        storageBucket: "meijin-system.firebasestorage.app",
        messagingSenderId: "935283801474",
        appId: "1:935283801474:web:4e161bff3b1c6ffb77a39b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.isAdmin = false;
    window.enrolledIds = [];
    let state = { players: [], active: null, archives: [], tourneyCount: 0 };

    window.checkLogin = () => {
        if(document.getElementById('adminUser').value === "admin" && document.getElementById('adminPass').value === "159753") {
            window.isAdmin = true;
            document.getElementById('loginFields').style.display = "none";
            document.getElementById('logoutBtn').style.display = "block";
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = "block");
            renderUI();
        }
    };

    onSnapshot(doc(db, "system", "current"), (docSnap) => {
        if (docSnap.exists()) {
            state = docSnap.data();
            renderUI();
        } else {
            setDoc(doc(db, "system", "current"), { players: [], archives: [], active: null, tourneyCount: 0 });
        }
    });

    window.dbAddPlayer = async () => {
        const n = document.getElementById('dbName').value, r = document.getElementById('dbRank').value;
        if(!n) return;
        const newPlayers = [...state.players, { id: Date.now().toString(), name: n, rank: r, points: 0 }];
        await updateDoc(doc(db, "system", "current"), { players: newPlayers });
        document.getElementById('dbName').value = "";
    };

    window.toggleEnroll = (id) => {
        const idx = window.enrolledIds.indexOf(id);
        idx === -1 ? window.enrolledIds.push(id) : window.enrolledIds.splice(idx,1);
    };

    window.tourneyStart = async () => {
        if(window.enrolledIds.length < 2) return alert("Select players");
        const participants = state.players.filter(p => window.enrolledIds.includes(p.id)).map(p => ({...p, tWins:0, pOpp:[]}));
        const newActive = { 
            name: document.getElementById('newTourneyName').value || "Tournament",
            players: participants,
            matches: []
        };
        await updateDoc(doc(db, "system", "current"), { active: newActive });
        window.enrolledIds = [];
    };

    window.generateMatches = async () => {
        let pool = [...state.active.players].sort((a,b) => b.tWins - a.tWins);
        let paired = new Set(), matches = [];
        for(let i=0; i<pool.length; i++){
            if(paired.has(pool[i].id)) continue;
            for(let j=i+1; j<pool.length; j++){
                if(!paired.has(pool[j].id) && !(pool[i].pOpp || []).includes(pool[j].id)){
                    matches.push({ id: Date.now()+j, p1: pool[i], p2: pool[j], p1B: Math.random()>0.5, winId: null });
                    paired.add(pool[i].id); paired.add(pool[j].id); break;
                }
            }
        }
        await updateDoc(doc(db, "system", "current"), { "active.matches": matches });
    };

    window.swapColors = async (mId) => {
        const matches = state.active.matches.map(m => m.id === mId ? {...m, p1B: !m.p1B} : m);
        await updateDoc(doc(db, "system", "current"), { "active.matches": matches });
    };

    window.setWinner = async (mId, wId, lId) => {
        const matches = state.active.matches.map(m => m.id === mId ? {...m, winId: wId} : m);
        const globalPlayers = state.players.map(p => {
            if(p.id === wId) return {...p, points: (p.points || 0) + 10};
            if(p.id === lId) return {...p, points: Math.max(0, (p.points || 0) - 5)};
            return p;
        });
        await updateDoc(doc(db, "system", "current"), { "active.matches": matches, "players": globalPlayers });
    };

    window.tourneyArchive = async () => {
        let count = (state.tourneyCount || 0) + 1;
        let players = state.players;
        let archives = state.archives;
        
        const winner = [...state.active.players].sort((a,b) => b.tWins - a.tWins)[0];
        archives = [{ name: state.active.name, winner: winner?.name || "N/A", date: new Date().toLocaleDateString() }, ...archives];

        // Reset Logic every 4 tournaments
        if(count >= 4) {
            alert("Season 4/4 finished! Points will reset for the next cycle.");
            count = 0;
            players = players.map(p => ({...p, points: 0}));
        }

        await updateDoc(doc(db, "system", "current"), {
            archives: archives,
            active: null,
            tourneyCount: count,
            players: players
        });
    };

    function renderUI() {
        // Rankings list (Sorted by points)
        const sortedPlayers = [...state.players].sort((a,b) => (b.points||0) - (a.points||0));
        document.getElementById('dbList').innerHTML = sortedPlayers.map(p => `
            <div class="player-row">
                <span><b>${p.name}</b> <small>(${p.rank})</small></span>
                <div>
                    <span class="points-badge">${p.points || 0} pts</span>
                    <input type="checkbox" ${!window.isAdmin?'disabled':''} onchange="toggleEnroll('${p.id}')">
                </div>
            </div>`).join('');

        // Honinbo Logic
        if(sortedPlayers.length >= 2 && sortedPlayers[0].points > 0) {
            document.getElementById('honinboBanner').style.display = "block";
            document.getElementById('qualifierNames').innerText = `${sortedPlayers[0].name} & ${sortedPlayers[1].name}`;
        } else {
            document.getElementById('honinboBanner').style.display = "none";
        }

        document.getElementById('cycleStatus').innerText = `Season Progress: ${state.tourneyCount || 0}/4 Tournaments`;
        document.getElementById('archiveList').innerHTML = state.archives.map(a => `<div class="history-item">üèÜ <b>${a.winner}</b> - ${a.name}</div>`).join('');

        const setup = document.getElementById('tourneySetup'), activeZone = document.getElementById('tourneyActive');
        if(!state.active) {
            setup.style.display = "block"; activeZone.style.display = "none";
            document.getElementById('tourneyTitle').innerText = "Tournament Hub";
        } else {
            setup.style.display = "none"; activeZone.style.display = "block";
            document.getElementById('tourneyTitle').innerText = state.active.name;
            document.getElementById('matchZone').innerHTML = state.active.matches.map(m => `
                <div class="match-box">
                    <div style="text-align:center; width:40%">
                        <div class="stone ${m.p1B?'black':'white'}"></div><br><b>${m.p1.name}</b><br>
                        ${!m.winId && window.isAdmin ? `<button onclick="setWinner(${m.id},'${m.p1.id}','${m.p2.id}')" class="btn-finish">Win</button>` : (m.winId===m.p1.id?'‚≠ê':'')}
                    </div>
                    <div style="text-align:center">VS<br>${!m.winId && window.isAdmin ? `<button class="btn-swap" onclick="swapColors(${m.id})">Swap</button>` : ''}</div>
                    <div style="text-align:center; width:40%">
                        <div class="stone ${m.p1B?'white':'black'}"></div><br><b>${m.p2.name}</b><br>
                        ${!m.winId && window.isAdmin ? `<button onclick="setWinner(${m.id},'${m.p2.id}','${m.p1.id}')" class="btn-finish">Win</button>` : (m.winId===m.p2.id?'‚≠ê':'')}
                    </div>
                </div>`).join('');

            const btnZone = document.getElementById('roundActions');
            if(state.active.matches.length === 0) {
                btnZone.innerHTML = window.isAdmin ? `<button class="btn-round" onclick="generateMatches()">Draw Pairs</button>` : `<p>Waiting for pairings...</p>`;
            } else { btnZone.innerHTML = ""; }
        }
    }
</script>
</body>
</html>
