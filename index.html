<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meijin System - Firebase Cloud Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --goban: #deb887; --ink: #1a1a1a; --paper: #fdfaf5; --accent: #8b0000; --win: #27ae60; }
        body { font-family: 'Quicksand', sans-serif; background-color: #f4ece0; background-image: radial-gradient(#d4a359 0.5px, transparent 0.5px); background-size: 20px 20px; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Admin Bar */
        .admin-bar { background: var(--ink); color: white; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .admin-inputs { display: flex; gap: 10px; }
        .admin-bar input { padding: 5px 10px; border-radius: 5px; border: none; width: 120px; }
        .admin-bar button { width: auto; padding: 5px 15px; margin: 0; font-size: 0.8rem; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        header { background: white; padding: 20px; border-radius: 20px; text-align: center; border-bottom: 8px solid var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 30px; position: relative; }
        .meijin-seal { position: absolute; top: 10px; right: 20px; border: 2px solid var(--accent); color: var(--accent); padding: 5px; font-family: 'Noto Serif JP', serif; font-weight: 900; transform: rotate(15deg); }
        
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { font-family: 'Noto Serif JP', serif; border-bottom: 2px solid var(--goban); padding-bottom: 10px; margin-top: 0; }
        
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #eee; border-radius: 8px; font-family: inherit; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-bottom: 5px; }
        .btn-add { background: var(--ink); color: white; }
        .btn-round { background: var(--accent); color: white; }
        .btn-finish { background: var(--win); color: white; }
        .btn-danger { background: #eee; color: #999; font-size: 0.7rem; }
        
        .scroll-area { max-height: 250px; overflow-y: auto; border: 1px solid #f0f0f0; padding: 10px; border-radius: 8px; }
        .player-row { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .match-box { background: var(--paper); border: 2px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .stone { width: 25px; height: 25px; border-radius: 50%; display: inline-block; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .black { background: #111; } .white { background: #fff; border: 1px solid #ccc; }
        .completed { background: #f0fff4; opacity: 0.8; }
        .history-item { font-size: 0.8rem; padding: 8px; border-left: 3px solid var(--accent); background: #fafafa; margin-bottom: 5px; }

        .admin-only { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-bar">
        <div id="loginStatus">Guest Mode (View Only)</div>
        <div class="admin-inputs" id="loginFields">
            <input type="text" id="adminUser" placeholder="Username">
            <input type="password" id="adminPass" placeholder="Password">
            <button onclick="checkLogin()">Login</button>
        </div>
        <button id="logoutBtn" style="display:none; width:auto; background:#444;" onclick="location.reload()">Logout</button>
    </div>

    <header>
        <div class="meijin-seal">Âêç‰∫∫</div>
        <h1>MEIJIN SYSTEM</h1>
        <p id="tourneyTitle">Connecting to Cloud...</p>
    </header>

    <div class="main-grid">
        <aside>
            <div class="card">
                <h3>Players</h3>
                <div class="admin-only">
                    <input type="text" id="dbName" placeholder="Name">
                    <input type="text" id="dbRank" placeholder="Rank (e.g. 1d)">
                    <button class="btn-add" onclick="dbAddPlayer()">Add to Database</button>
                </div>
                <div class="scroll-area" id="dbList"></div>
            </div>
            <div class="card">
                <h3>Stats</h3>
                <select id="statPlayer" onchange="updateChart()"></select>
                <div style="height:200px"><canvas id="statChart"></canvas></div>
            </div>
        </aside>

        <main>
            <div id="tourneySetup" class="card" style="display:none;">
                <h3>New Tournament</h3>
                <div class="admin-only">
                    <input type="text" id="newTourneyName" placeholder="Event Name">
                    <button class="btn-round" onclick="tourneyStart()">Start Event</button>
                </div>
                <p id="guestMsg"><small>Waiting for admin to start a tournament...</small></p>
            </div>

            <div id="tourneyActive" class="card" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Round <span id="roundNum">1</span></h3>
                    <button onclick="tourneyArchive()" class="btn-finish admin-only" style="width:auto;">Archive Tournament</button>
                </div>
                <div id="roundActions"></div>
                <div id="matchZone"></div>
            </div>

            <div class="card">
                <h3>Hall of Fame</h3>
                <div class="scroll-area" id="archiveList"></div>
                <button class="btn-danger admin-only" onclick="fullReset()">Factory Reset Database</button>
            </div>
        </main>
    </div>
</div>

<script type="module">
    // FIREBASE SETUP
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDzse9aVDIAFscTbGs-3Disy2wdRHWPRF0",
        authDomain: "meijin-system.firebaseapp.com",
        databaseURL: "https://meijin-system-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "meijin-system",
        storageBucket: "meijin-system.firebasestorage.app",
        messagingSenderId: "935283801474",
        appId: "1:935283801474:web:4e161bff3b1c6ffb77a39b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // STATE
    window.isAdmin = false;
    let cloudData = { players: [], archives: [], activeTourney: null };
    let enrolledIds = [];
    let chartObj = null;

    // AUTH
    window.checkLogin = () => {
        if(document.getElementById('adminUser').value === "admin" && document.getElementById('adminPass').value === "159753") {
            window.isAdmin = true;
            document.getElementById('loginFields').style.display = "none";
            document.getElementById('logoutBtn').style.display = "block";
            document.getElementById('loginStatus').innerText = "Admin Access Granted";
            document.getElementById('loginStatus').style.color = "#27ae60";
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = "block");
            document.getElementById('guestMsg').style.display = "none";
            refreshState();
        } else { alert("Access Denied"); }
    };

    // SYNC
    onValue(ref(db, '/'), (snapshot) => {
        const data = snapshot.val();
        cloudData.players = data?.players || [];
        cloudData.archives = data?.archives || [];
        cloudData.activeTourney = data?.activeTourney || null;
        refreshState();
    });

    // FUNCTIONS
    window.dbAddPlayer = () => {
        const n = document.getElementById('dbName').value, r = document.getElementById('dbRank').value;
        if(!n || !r) return;
        const newList = [...cloudData.players, { id: Date.now().toString(), name: n, rank: r, totalWins: 0, totalLosses: 0 }];
        set(ref(db, 'players'), newList);
        document.getElementById('dbName').value = "";
    };

    window.toggleEnroll = (id) => {
        const idx = enrolledIds.indexOf(id);
        idx === -1 ? enrolledIds.push(id) : enrolledIds.splice(idx,1);
    };

    window.tourneyStart = () => {
        const name = document.getElementById('newTourneyName').value || "Winter Season";
        if(enrolledIds.length < 2) return alert("Select at least 2 players");
        const participants = cloudData.players.filter(p => enrolledIds.includes(p.id)).map(p => ({...p, wins:0, pOpp:[]}));
        set(ref(db, 'activeTourney'), { name, round: 1, players: participants, matches: [] });
        enrolledIds = [];
    };

    window.generateMatches = () => {
        let pool = [...cloudData.activeTourney.players].sort((a,b) => cloudData.activeTourney.round === 1 ? rankVal(b.rank) - rankVal(a.rank) : b.wins - a.wins);
        let paired = new Set(), matches = [];
        for(let i=0; i<pool.length; i++) {
            if(paired.has(pool[i].id)) continue;
            let found = false;
            for(let j=i+1; j<pool.length; j++) {
                if(!paired.has(pool[j].id) && !(pool[i].pOpp || []).includes(pool[j].id)) {
                    matches.push({ id: Date.now()+j, p1: pool[i], p2: pool[j], p1B: Math.random()>0.5, winId: null });
                    paired.add(pool[i].id); paired.add(pool[j].id);
                    found = true; break;
                }
            }
            if(!found && !paired.has(pool[i].id)) { pool[i].wins++; paired.add(pool[i].id); }
        }
        update(ref(db, 'activeTourney'), { matches, players: pool });
    };

    window.setWinner = (mId, wId, lId) => {
        if(!window.isAdmin) return;
        const matches = [...cloudData.activeTourney.matches];
        matches.find(m => m.id === mId).winId = wId;
        const players = [...cloudData.activeTourney.players];
        players.find(p => p.id === wId).wins++;
        (players.find(p => p.id === wId).pOpp = players.find(p => p.id === wId).pOpp || []).push(lId);
        (players.find(p => p.id === lId).pOpp = players.find(p => p.id === lId).pOpp || []).push(wId);
        const globalP = [...cloudData.players];
        globalP.find(p => p.id === wId).totalWins++;
        globalP.find(p => p.id === lId).totalLosses++;
        update(ref(db, '/'), { 'activeTourney/matches': matches, 'activeTourney/players': players, 'players': globalP });
    };

    window.nextRound = () => {
        update(ref(db, 'activeTourney'), { round: cloudData.activeTourney.round + 1, matches: [] });
    };

    window.tourneyArchive = () => {
        const winner = [...cloudData.activeTourney.players].sort((a,b) => b.wins - a.wins)[0];
        const archives = [{ name: cloudData.activeTourney.name, winner: winner.name, date: new Date().toLocaleDateString() }, ...cloudData.archives];
        update(ref(db, '/'), { archives, activeTourney: null });
    };

    window.fullReset = () => { if(confirm("ERASE CLOUD DATABASE?")) set(ref(db, '/'), null); };

    function refreshState() {
        // Render DB
        const list = document.getElementById('dbList'), sel = document.getElementById('statPlayer');
        list.innerHTML = ""; sel.innerHTML = "<option value=''>Player Stats...</option>";
        cloudData.players.forEach(p => {
            const isIn = cloudData.activeTourney?.players.find(ap => ap.id === p.id);
            list.innerHTML += `<div class="player-row"><span>${p.name} (${p.rank})</span><input type="checkbox" ${isIn?'checked disabled':''} ${!window.isAdmin?'disabled':''} onchange="toggleEnroll('${p.id}')"></div>`;
            sel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });

        // Render Archives
        document.getElementById('archiveList').innerHTML = cloudData.archives.map(a => `<div class="history-item"><strong>${a.name}</strong> - Champion: ${a.winner} (${a.date})</div>`).join('');

        // Tournament View
        const setup = document.getElementById('tourneySetup'), active = document.getElementById('tourneyActive'), title = document.getElementById('tourneyTitle');
        if(!cloudData.activeTourney) {
            setup.style.display = "block"; active.style.display = "none";
            title.innerText = "Meijin System - Hub";
        } else {
            setup.style.display = "none"; active.style.display = "block";
            title.innerText = cloudData.activeTourney.name;
            document.getElementById('roundNum').innerText = cloudData.activeTourney.round;
            const matches = cloudData.activeTourney.matches || [];
            document.getElementById('matchZone').innerHTML = matches.map(m => `
                <div class="match-box ${m.winId?'completed':''}">
                    <div style="text-align:center; width:40%"><div class="stone ${m.p1B?'black':'white'}"></div><br>${m.p1.name}<br>${!m.winId && window.isAdmin?`<button onclick="setWinner(${m.id},'${m.p1.id}','${m.p2.id}')" class="btn-finish">Win</button>`:(m.winId===m.p1.id?'üèÜ':'')}</div>
                    <strong>VS</strong>
                    <div style="text-align:center; width:40%"><div class="stone ${m.p1B?'white':'black'}"></div><br>${m.p2.name}<br>${!m.winId && window.isAdmin?`<button onclick="setWinner(${m.id},'${m.p2.id}','${m.p1.id}')" class="btn-finish">Win</button>`:(m.winId===m.p2.id?'üèÜ':'')}</div>
                </div>`).join('');
            const actArea = document.getElementById('roundActions');
            if(matches.length > 0 && matches.every(m => m.winId)) {
                actArea.innerHTML = window.isAdmin ? `<button class="btn-round" onclick="nextRound()">Start Next Round</button>` : `<p style="color:var(--win)">Round Over</p>`;
            } else if(matches.length === 0) {
                actArea.innerHTML = window.isAdmin ? `<button class="btn-round" onclick="generateMatches()">Draw Pairings</button>` : `<p>Waiting for pairings...</p>`;
            } else { actArea.innerHTML = ""; }
        }
    }

    window.updateChart = () => {
        const p = cloudData.players.find(x => x.id === document.getElementById('statPlayer').value);
        if(!p) return;
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(document.getElementById('statChart'), { type: 'doughnut', data: { labels: ['W','L'], datasets: [{ data: [p.totalWins, p.totalLosses], backgroundColor: ['#27ae60','#333'] }] }, options: { maintainAspectRatio: false } });
    };

    function rankVal(r) { r = r.toLowerCase(); return r.includes('k') ? 30-parseInt(r) : 30+parseInt(r); }
</script>
</body>
</html>
